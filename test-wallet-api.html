<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet Auto-Registration API Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 10px 10px 0;
      transition: background 0.2s;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .code-block {
      background: #1f2937;
      color: #f3f4f6;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    h1 {
      color: #1f2937;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
    }
    .wallet-info {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }
    .wallet-info h3 {
      margin-top: 0;
      color: #374151;
    }
    .wallet-info div {
      margin: 8px 0;
      color: #6b7280;
    }
    .wallet-info strong {
      color: #111827;
    }
  </style>
</head>
<body>
  <h1>üîê Wallet Auto-Registration API Test</h1>
  <p class="subtitle">Test the Digital Credentials Wallet Selector extension API</p>

  <div id="extension-status"></div>

  <div class="wallet-info">
    <h3>Test Wallet Information</h3>
    <div><strong>Name:</strong> Test Wallet</div>
    <div><strong>URL:</strong> <span id="wallet-url"></span></div>
    <div><strong>Description:</strong> A test wallet for API demonstration</div>
    <div><strong>Icon:</strong> üß™</div>
    <div><strong>Color:</strong> #10b981</div>
  </div>

  <button id="check-extension" onclick="checkExtension()">1. Check Extension</button>
  <button id="check-wallet" onclick="checkWallet()" disabled>2. Check if Registered</button>
  <button id="register-wallet" onclick="registerWallet()" disabled>3. Register Wallet</button>
  <button id="trigger-api" onclick="triggerDCAPI()">4. Trigger DC API Call</button>

  <div id="output"></div>

  <div class="code-block" id="api-code">
// Wallet information
const walletInfo = {
  name: 'Test Wallet',
  url: window.location.origin,
  description: 'A test wallet for API demonstration',
  icon: 'üß™',
  color: '#10b981'
};

// Check extension
if (window.DCWS?.isInstalled()) {
  console.log('Extension detected!');
  
  // Register wallet
  const result = await window.DCWS.registerWallet(walletInfo);
  console.log('Registration result:', result);
}
  </div>

  <script>
    // Set the wallet URL
    document.getElementById('wallet-url').textContent = window.location.origin;

    const walletInfo = {
      name: 'Test Wallet',
      url: window.location.origin,
      description: 'A test wallet for API demonstration',
      icon: 'üß™',
      color: '#10b981'
    };

    function showStatus(message, type = 'info') {
      const output = document.getElementById('output');
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
      output.appendChild(statusDiv);
      
      // Scroll to bottom
      statusDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function checkExtension() {
      const output = document.getElementById('output');
      output.innerHTML = '';

      if (typeof window.DigitalCredentialsWalletSelector === 'undefined') {
        showStatus('‚ùå Extension NOT detected. Please install the Digital Credentials Wallet Selector extension.', 'error');
        return;
      }

      if (window.DCWS.isInstalled()) {
        showStatus(`‚úÖ Extension detected! Version: ${window.DCWS.version}`, 'success');
        document.getElementById('check-wallet').disabled = false;
        document.getElementById('extension-status').innerHTML = 
          '<div class="status success">Extension is installed and ready!</div>';
      } else {
        showStatus('‚ùå Extension API found but not active', 'error');
      }
    }

    async function checkWallet() {
      try {
        showStatus('Checking wallet registration...', 'info');
        
        const isRegistered = await window.DCWS.isWalletRegistered(walletInfo.url);
        
        if (isRegistered) {
          showStatus('‚úÖ Wallet is already registered with the extension', 'success');
          document.getElementById('register-wallet').textContent = '3. Already Registered';
        } else {
          showStatus('‚ÑπÔ∏è Wallet is NOT registered yet', 'info');
          document.getElementById('register-wallet').disabled = false;
        }
      } catch (error) {
        showStatus('‚ùå Error checking wallet: ' + error.message, 'error');
      }
    }

    async function registerWallet() {
      try {
        const btn = document.getElementById('register-wallet');
        btn.disabled = true;
        btn.textContent = 'Registering...';
        
        showStatus('Registering wallet with extension...', 'info');
        
        const result = await window.DCWS.registerWallet(walletInfo);
        
        if (result.alreadyRegistered) {
          showStatus('‚ÑπÔ∏è Wallet was already registered. No changes made.', 'info');
          showStatus(`<strong>Wallet ID:</strong> ${result.wallet.id}<br>
                      <strong>Name:</strong> ${result.wallet.name}<br>
                      <strong>URL:</strong> ${result.wallet.url}`, 'info');
        } else {
          showStatus('‚úÖ Wallet successfully registered!', 'success');
          showStatus(`<strong>Wallet ID:</strong> ${result.wallet.id}<br>
                      <strong>Name:</strong> ${result.wallet.name}<br>
                      <strong>URL:</strong> ${result.wallet.url}<br>
                      <strong>Auto-Registered:</strong> ${result.wallet.autoRegistered}<br>
                      <strong>Registered At:</strong> ${result.wallet.registeredAt}`, 'success');
          showStatus('üí° You can now see this wallet in the extension popup and use it for credential requests!', 'info');
        }
        
        btn.textContent = '‚úì Registered';
      } catch (error) {
        showStatus('‚ùå Registration failed: ' + error.message, 'error');
        document.getElementById('register-wallet').disabled = false;
        document.getElementById('register-wallet').textContent = '3. Register Wallet';
      }
    }

    async function triggerDCAPI() {
      showStatus('Triggering Digital Credentials API call...', 'info');
      
      try {
        const credential = await navigator.credentials.get({
          digital: true,
          mediation: 'optional',
          identity: {
            providers: [{
              protocol: 'openid4vp',
              request: JSON.stringify({
                client_id: 'test-client',
                response_type: 'vp_token',
                presentation_definition: {
                  id: 'test-definition',
                  input_descriptors: [{
                    id: 'test-descriptor',
                    name: 'Test Credential',
                    purpose: 'Testing the DC API'
                  }]
                }
              })
            }]
          }
        });
        
        showStatus('‚úÖ Credential received: ' + JSON.stringify(credential, null, 2), 'success');
      } catch (error) {
        if (error.name === 'AbortError' && error.message.includes('cancelled')) {
          showStatus('‚ÑπÔ∏è User cancelled the wallet selection', 'info');
        } else {
          showStatus('‚ùå DC API call failed: ' + error.message, 'error');
        }
      }
    }

    // Auto-check on page load
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        checkExtension();
      }, 500);
    });
  </script>
</body>
</html>
